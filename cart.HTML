<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Course Store — Корзина</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

<header>
    <div class="logo">Корзина</div>
    <nav>
        <a href="catalog.html">Каталог</a>
        <a href="profile.html">Профиль</a>
    </nav>
</header>

<div class="container">
    <div id="cart"></div>
</div>

<script src="assets/script.js"></script>
<script>
const user = getUser();
if (!user) {
    window.location.href = "login.html";
}

function renderCartEmpty() {
    document.getElementById("cart").innerHTML = "<h3>Корзина пуста</h3>";
}

function loadCart() {
    fetch(`${API}/api/cart?user_id=${user.user_id}`)
    .then(r => r.json())
    .then(d => {
        const block = document.getElementById("cart");

        if (!d.items || d.items.length === 0) {
            renderCartEmpty();
            return;
        }

        block.innerHTML = "";
        d.items.forEach(item => {
            const imgSrc = item.image_url || "assets/default.jpg";

            const card = document.createElement("div");
            card.className = "list-card";
            card.innerHTML = `
                <img src="${imgSrc}" alt="">
                <div class="list-card-main">
                    <h3 class="list-card-title">${item.title}</h3>
                    <div class="list-card-meta">
                        <span class="price">${item.price} ₸</span>
                        <button class="btn btn-danger">Удалить</button>
                    </div>
                </div>
            `;

            card.querySelector("button").onclick = () => removeItem(item.cart_id);
            block.appendChild(card);
        });

        block.innerHTML += `
            <div class="cart-total">Итого: ${d.total} ₸</div>
            <button class="btn btn-primary" style="margin-top:8px;" onclick="buy()">Оплатить</button>
        `;
    })
    .catch(e => {
        console.error(e);
        document.getElementById("cart").innerHTML = "<p>Ошибка загрузки корзины.</p>";
    });
}

function removeItem(id) {
    fetch(`${API}/api/cart/remove`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ cart_id: id })
    })
    .then(() => loadCart())
    .catch(() => showMessage("Ошибка удаления"));
}

function buy() {
    fetch(`${API}/api/cart/buy`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ user_id: user.user_id })
    })
    .then(r => r.json())
    .then(d => {
        if (d.status === "ok") {
            showMessage("Покупка успешна!");
            loadCart();
        } else {
            showMessage(d.message || "Не удалось оплатить");
        }
    })
    .catch(() => showMessage("Ошибка оплаты"));
}

loadCart();
</script>

</body>
</html>
