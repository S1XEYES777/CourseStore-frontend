<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Course Store ‚Äî –ö–∞—Ç–∞–ª–æ–≥</title>

    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

<header class="site-header">
    <div class="container navbar">
        <div class="logo">
            <span>CS</span> –ö–∞—Ç–∞–ª–æ–≥
        </div>

        <nav class="nav-links">
            <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a class="active" href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a>
            <a href="cart.html">–ö–æ—Ä–∑–∏–Ω–∞</a>
            <a href="profile.html">–ü—Ä–æ—Ñ–∏–ª—å</a>
        </nav>
    </div>
</header>

<section class="section">
    <div class="container">

        <div class="section-header">
            <h2 class="section-title">–í—Å–µ –∫—É—Ä—Å—ã</h2>
            <p class="section-subtitle">–û–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</p>
        </div>

        <div id="catalog" class="course-grid"></div>

    </div>
</section>

<div class="toast-container"></div>

<script src="assets/script.js"></script>

<script>
const API = "https://coursestore-backend.onrender.com";
const catalogBlock = document.getElementById("catalog");

/* =============================
   üìå –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
============================= */
async function loadCatalog() {
    try {
        const res = await fetch(`${API}/api/courses`);
        const data = await res.json();

        catalogBlock.innerHTML = "";

        if (data.status !== "ok" || !data.courses.length) {
            catalogBlock.innerHTML = "<p class='section-subtitle'>–ö—É—Ä—Å—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>";
            return;
        }

        data.courses.forEach(course => {

            /* üî• –ü–†–ê–í–ò–õ–¨–ù–û–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï ‚Äî Base64 */
            const imgSrc = course.image
                ? "data:image/jpeg;base64," + course.image
                : "assets/default.jpg";

            const card = document.createElement("div");
            card.className = "course-card";

            card.innerHTML = `
                <div class="course-thumb">
                    <img src="${imgSrc}" alt="${course.title}">
                </div>

                <div class="course-body">
                    <span class="course-badge">–ö—É—Ä—Å</span>

                    <h3 class="course-title">${course.title}</h3>

                    <div class="course-meta">
                        <span>${course.author}</span>
                        <span class="course-price">${course.price} ‚Ç∏</span>
                    </div>
                </div>

                <div class="course-footer">
                    <button class="btn btn-primary btn-small add-btn">–í –∫–æ—Ä–∑–∏–Ω—É</button>
                    <a href="course.html?id=${course.id}" class="btn btn-ghost btn-small">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
                </div>
            `;

            // üõí –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É —á–µ—Ä–µ–∑ BACKEND
            card.querySelector(".add-btn").onclick = () => addToCart(course.id);

            catalogBlock.appendChild(card);
        });

    } catch (e) {
        catalogBlock.innerHTML = "<p class='section-subtitle'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞.</p>";
    }
}

/* =============================
   üõí –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ—Ä–∑–∏–Ω—É —á–µ—Ä–µ–∑ backend
============================= */
async function addToCart(course_id) {
    const user = getUser();
    if (!user) return (window.location = "login.html");

    try {
        const res = await fetch(`${API}/api/cart/add`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                user_id: user.user_id,
                course_id: course_id
            })
        });

        const data = await res.json();

        if (data.status === "ok") {
            showMessage("–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É!", "success");
        } else {
            showMessage(data.message || "–û—à–∏–±–∫–∞", "warning");
        }
    } catch (e) {
        showMessage("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞", "error");
    }
}

loadCatalog();
</script>

</body>
</html>

