<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Course Store ‚Äî –ö–æ—Ä–∑–∏–Ω–∞</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

<header class="site-header">
    <div class="container">
        <div class="navbar">
            <div class="logo">
                <span>CS</span> –ö–æ—Ä–∑–∏–Ω–∞
            </div>
            <nav class="nav-links">
                <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
                <a href="catalog.html">–ö–∞—Ç–∞–ª–æ–≥</a>
                <a class="active" href="cart.html">–ö–æ—Ä–∑–∏–Ω–∞</a>
                <a href="profile.html">–ü—Ä–æ—Ñ–∏–ª—å</a>
            </nav>
        </div>
    </div>
</header>

<main class="cart-page">
    <div class="container">

        <section class="cart-card glass-card">
            <h1 style="margin:0 0 12px;">–¢–≤–æ—è –∫–æ—Ä–∑–∏–Ω–∞</h1>
            <p class="balance-note" style="margin-bottom:16px;">
                –ó–¥–µ—Å—å –Ω–∞—Ö–æ–¥—è—Ç—Å—è –∫—É—Ä—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –≤—ã–±—Ä–∞–ª –¥–ª—è –ø–æ–∫—É–ø–∫–∏.
            </p>

            <div id="cart"></div>
            <div id="cart-footer" style="margin-top:20px;"></div>

        </section>

    </div>
</main>

<footer class="site-footer">
    <div class="container">
        –°–∞–π—Ç —Å–æ–∑–¥–∞–Ω –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–µ –∏ –Ω–µ –ø—Ä–µ—Ç–µ–Ω–¥—É–µ—Ç –Ω–∞ –∞–≤—Ç–æ—Ä—Å–∫–∏–µ –ø—Ä–∞–≤–∞.
    </div>
</footer>

<script src="assets/script.js"></script>

<script>
const API = "https://coursestore-backend.onrender.com";

const user = getUser();
if (!user) location.href = "login.html";

/* =============================
   üìå –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã —Å backend
============================= */
async function loadCart() {
    const block = document.getElementById("cart");
    const footer = document.getElementById("cart-footer");

    block.innerHTML = `<p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>`;

    try {
        const r = await fetch(`${API}/api/cart?user_id=${user.user_id}`);
        const data = await r.json();

        if (data.status !== "ok" || data.items.length === 0) {
            block.innerHTML = `
                <p class="balance-note" style="font-size:15px;margin:12px 0;">
                    –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞. –î–æ–±–∞–≤—å —á—Ç–æ-–Ω–∏–±—É–¥—å –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞.
                </p>`;
            footer.innerHTML = "";
            return;
        }

        let items = data.items;
        block.innerHTML = "";
        let total = 0;

        items.forEach(item => {
            total += item.price;

            let imgSrc =
                item.image
                    ? "data:image/jpeg;base64," + item.image
                    : (item.image_url || "assets/default.jpg");

            const card = document.createElement("div");
            card.className = "list-card glass-inner";

            card.innerHTML = `
                <img src="${imgSrc}" style="border-radius:12px; width:180px; height:110px; object-fit:cover;">
                <div class="list-card-main">
                    <h3 class="list-card-title">${item.title}</h3>
                    <div class="list-description">${item.description.substring(0, 80)}...</div>

                    <div class="list-card-meta" style="margin-top:10px;">
                        <span class="price">${item.price} ‚Ç∏</span>
                        <button class="btn btn-danger" style="padding:6px 12px;">
                            –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `;

            card.querySelector("button").onclick = () => removeItem(item.cart_id);
            block.appendChild(card);
        });

        footer.innerHTML = `
            <div class="glass-inner" style="
                padding:14px 18px;
                border-radius:16px;
                margin-bottom:12px;
                display:flex;
                justify-content:space-between;
                font-size:16px;">
                <span>–ò—Ç–æ–≥–æ:</span>
                <strong>${total} ‚Ç∏</strong>
            </div>

            <button class="btn btn-primary btn-block" style="padding:12px;font-size:16px;"
                    onclick="buy()">
                –û–ø–ª–∞—Ç–∏—Ç—å
            </button>
        `;

    } catch (e) {
        block.innerHTML = `<p class="balance-note">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ—Ä–∑–∏–Ω—ã</p>`;
    }
}

/* =============================
   ‚ùå –£–¥–∞–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
============================= */
async function removeItem(cart_id) {
    const r = await fetch(`${API}/api/cart/remove`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({cart_id})
    });

    loadCart();
}

/* =============================
   üí≥ –ü–æ–∫—É–ø–∫–∞
============================= */
async function buy() {
    const r = await fetch(`${API}/api/cart/buy`, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({user_id: user.user_id})
    });

    const res = await r.json();
    if (res.status === "ok") {
        showMessage("–ü–æ–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–∞!", "success");
        loadCart();
    } else {
        showMessage(res.message || "–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã", "error");
    }
}

loadCart();
</script>

</body>
</html>
