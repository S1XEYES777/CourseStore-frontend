<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Course Store — Корзина</title>
    <link rel="stylesheet" href="assets/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>

<header class="site-header">
    <div class="container">
        <div class="navbar">
            <div class="logo">
                <span>CS</span> Корзина
            </div>
            <nav class="nav-links">
                <a href="index.html">Главная</a>
                <a href="catalog.html">Каталог</a>
                <a class="active" href="cart.html">Корзина</a>
                <a href="profile.html">Профиль</a>
            </nav>
        </div>
    </div>
</header>

<main class="cart-page">
    <div class="container">

        <section class="cart-card glass-card">
            <h1 style="margin:0 0 12px;">Твоя корзина</h1>
            <p class="balance-note" style="margin-bottom:16px;">
                Здесь находятся курсы, которые ты выбрал для покупки.
            </p>

            <div id="cart"></div>
            <div id="cart-footer" style="margin-top:20px;"></div>

        </section>

    </div>
</main>

<footer class="site-footer">
    <div class="container">
        Сайт создан для проекта в университете и не претендует на авторские права.
    </div>
</footer>

<script src="assets/script.js"></script>

<script>
const user = getUser();
if (!user) location.href = "login.html";

// =======================
//  КОРЗИНА в localStorage
// =======================

function getCart() {
    return JSON.parse(localStorage.getItem("cart") || "[]");
}

function saveCart(cart) {
    localStorage.setItem("cart", JSON.stringify(cart));
}

function emptyCartUI() {
    document.getElementById("cart").innerHTML =
        `<p class="balance-note" style="font-size:15px;margin:12px 0;">
            Корзина пуста. Добавь что-нибудь из каталога.
         </p>`;
    document.getElementById("cart-footer").innerHTML = "";
}

function loadCart() {
    const cart = getCart();
    const cartBlock = document.getElementById("cart");
    const footer = document.getElementById("cart-footer");

    if (cart.length === 0) {
        emptyCartUI();
        return;
    }

    cartBlock.innerHTML = "";
    let total = 0;

    cart.forEach(item => {
        total += item.price;

        const imgSrc = item.image_url
            ? (API + item.image_url)
            : "assets/default.jpg";

        const card = document.createElement("div");
        card.className = "list-card glass-inner";

        card.innerHTML = `
            <img src="${imgSrc}" style="border-radius:12px;">
            <div class="list-card-main">
                <h3 class="list-card-title">${item.title}</h3>
                <div class="list-description">${(item.description || "").substring(0,80)}...</div>

                <div class="list-card-meta" style="margin-top:10px;">
                    <span class="price">${item.price} ₸</span>
                    <button class="btn btn-danger" style="padding:6px 12px;">
                        Удалить
                    </button>
                </div>
            </div>
        `;

        card.querySelector("button").onclick = () => removeItem(item.id);
        cartBlock.appendChild(card);
    });

    footer.innerHTML = `
        <div class="glass-inner" style="
            padding:14px 18px;
            border-radius:16px;
            margin-bottom:12px;
            display:flex;
            justify-content:space-between;
            font-size:16px;
        ">
            <span>Итого:</span>
            <strong>${total} ₸</strong>
        </div>

        <button class="btn btn-primary btn-block" style="padding:12px;font-size:16px;"
                onclick="buy()">
            Оплатить
        </button>
    `;
}

function removeItem(id) {
    let cart = getCart();
    cart = cart.filter(i => i.id !== id);
    saveCart(cart);
    showMessage("Удалено", "success");
    loadCart();
}

// =======================
//    ПОКУПКА
// =======================

function buy() {
    const cart = getCart();
    if (cart.length === 0) return;

    // добавляем в список покупок у пользователя
    user.purchased = user.purchased || [];

    cart.forEach(c => {
        if (!user.purchased.find(p => p.id === c.id)) {
            user.purchased.push(c);
        }
    });

    saveUser(user);

    // очищаем корзину
    saveCart([]);
    showMessage("Покупка успешна!", "success");
    loadCart();
}

loadCart();
</script>

</body>
</html>
